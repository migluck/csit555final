{% extends 'base.html' %}

{% block content %}
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"
        integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1"
        crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"
        integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM"
        crossorigin="anonymous"></script>

<script>
    $( document ).ready(function() {
        updateFilterTable();
    });

    $(document).on("click", ".editButton", function () {
         var companyName = $(this).data('company');
         $(".modal-body #editCompanyInput").val(companyName);

         var amount = $(this).data('amount');
         $(".modal-body #editAmountInput").val(amount);

         var paymentDate = $(this).data('paymentdate');
         $(".modal-body #editPaymentdateInput").val(paymentDate);

         var status = $(this).data('status');
         $(".modal-body #editStatusInput").val(status);

         var dueDate = $(this).data('duedate');
         $("#editModal .modal-body #editDuedateInput").val(DueDate);
    });

    $(document).on("click", ".deleteButton", function () {
         var paymentID = $(this).data('paymentid');
         $("#deleteModal .modal-footer #deletePaymentidInput").val(paymentID);
    });

    document.addEventListener('DOMContentLoaded', e => {
        document.forms.edit.addEventListener('change', e => {
            if (e.target.name == 'status') {
                let status = e.target.form.status.value == "paid" ? false : true;
                e.target.form.paymentdatefield.disabled = status.valueOf();
            }
        });
    });

    function updateFilterTable() {
        console.log("update filter table");
        var dueDate = $("#duedatefilter").val();
        var amountSum = 0;
        $("#FilterTable tbody tr").each(function(){
            if($(this).children(".PaymentDateCell").text() == dueDate) {
                $(this).hide();
            } else {
                amountSum += Number($(this).children(".AmountCell").text());
            }
        });

        var taxRate = $("#taxratefilter").val();

        var taxDue = amountSum * (Number(taxRate) / 100);

        $("#TotalAmount").text("$" + amountSum);
        $("#TaxRate").text(taxRate + "%");
        $("#TaxDue").text("$" + taxDue.toFixed(2));
    }

</script>
<h3>{% block title %} All Payments {% endblock %}</h3>
<p>Explanation text</p>
<div class="scrollbox">
    <table>
        <thead>
        <th>Company</th>
        <th>Amount</th>
        <th>Payment Date</th>
        <th>Status</th>
        <th>Due Date</th>
        <th>Actions</th>
        </thead>
        <tbody>
        {% for data in payments %}
        <tr>
        <td>{{data.company}}</td>
        <td>{{data.amount}}</td>
        <td>{{data.payment_date}}</td>
        <td>{{data.status}}</td>
        <td>{{data.due_date}}</td>
        <td>
            <button type="button" class="editButton btn btn-info btn-sm" data-toggle="modal" data-target="#editModal"
                    data-backdrop="static" data-paymentid="{{data.id}}" data-company="{{data.company}}" data-amount="{{data.amount}}"
                    data-paymentdate="{{data.payment_date}}" data-status="{{data.status}}"
                    data-duedate="{{data.due_date}}">Edit
            </button>
            <button type="button" class="deleteButton btn btn-info btn-sm" data-toggle="modal"
                    data-target="#deleteModal" data-backdrop="static" data-paymentid="{{data.id}}">Delete
            </button>
        </td>
        </tr>
        {% endfor%}
        </tbody>
    </table>
</div>
<br>
<h3>Payment Summary</h3>
<p>Please select a due date from the drop-down and enter the tax rate to calculate the taxes owed.</p>
<form id="filter" name="filter">
    <label for="duedatefilter">Due Date</label>
    <select id="duedatefilter" name="duedatefilter" onchange="updateFilterTable()">
        <option value="" disabled selected>Select due date</option>
        {% for date in duedates %}
        <option value="{{date}}">{{date}}</option>
        {% endfor%}
    </select>
    <label>Tax rate</label>
    <input id="taxratefilter" type="number" name="taxratefilter" value="0" min="0" max="100" onchange="updateFilterTable()">
</form>
<table id="FilterTable">
    <thead>
    <th>Company</th>
    <th>Amount</th>
    <th>Payment Date</th>
    <th>Status</th>
    <th>Due Date</th>
    </thead>
    <tbody>
        {% for data in payments %}
        <tr id="PaymentID{{data.Student_number}}">
            <td class="CompanyCell">{{data.Company}}</td>
            <td class="AmountCell">{{data.Amount}}</td>
            <td class="PaymentdateCell">{{data.PaymentDate}}</td>
            <td class="StatusCell">{{data.Status}}</td>
            <td class="DuedateCell">{{data.DueDate}}</td>
        </tr>
        {% endfor%}
    </tbody>
    <tfoot>
        <tr>
            <td colspan="4">Total Amount</td>
            <td id="TotalAmount">$100</td>
        </tr>
        <tr>
            <td colspan="4">Tax Rate</td>
            <td id="TaxRate">6%</td>
        </tr>
        <tr>
            <td colspan="4">Tax Due</td>
            <td id="TaxDue">$6</td>
        </tr>
    </tfoot>
</table>
<div id="editModal" class="modal fade" role="dialog">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title">Edit Payment</h4>
            </div>
            <div class="modal-body">
                <form name="edit" action="/edit" method="POST">
                    <label>Company Name</label>
                    <input id="editCompanyInput" type="text" name="company" value="Apple" required>
                    <label>Amount</label>
                    <input id="editAmountInput" type="number" name="amount" value="1000" required>
                    <label for="editStatusInput">Payment Status</label>
                    <select id="editStatusInput" name="status" required>
                        <option value="unpaid">Unpaid</option>
                        <option value="paid" selected>Paid</option>
                    </select>
                    <fieldset name="paymentdatefield" disabled>
                        <label>Payment Date</label>
                        <input id="editPaymentdateInput" type="date" name="paymentdate" placeholder="Payment Date"
                               required>
                    </fieldset>
                    <label for="editDuedateInput">Due Date</label>
                    <select id="editDuedateInput" name="duedate" required>
                        {% for date in duedates %}
                        <option value="{{date}}">{{date}}</option>
                        {% endfor%}
                    </select>
                    <button type="submit" class="btn btn-default" data-dismiss="modal">Save</button>
                    <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                </form>
            </div>
        </div>
    </div>
</div>
<div id="deleteModal" class="modal fade" role="dialog">
    <div class="modal-dialog">
        <div class="modal-content modal-sm">
            <div class="modal-header">
                <h4 class="modal-title">Delete</h4>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this payment?</p>
            </div>
            <div class="modal-footer">
                <form name="delete" action="http://127.0.0.1:5000/payments/147" method="POST">
                    <input type="hidden" id="deletePaymentidInput" name="paymentId" value="0">
                    <button type="submit" class="btn btn-default" data-dismiss="modal">Delete</button>
                    <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                </form>
            </div>
        </div>

    </div>
</div>
{% endblock %}